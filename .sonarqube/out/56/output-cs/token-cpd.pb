Ö	
íC:\Users\jay.ahir\Desktop\OrchardCore-main\OrchardCore-main\src\OrchardCore\OrchardCore.FileStorage.AmazonS3\AmazonWebServiceResponseExtensions.cs
	namespace 	
OrchardCore
 
. 
FileStorage !
.! "
AmazonS3" *
;* +
public 
static 
class .
"AmazonWebServiceResponseExtensions 6
{ 
public 

static 
bool 
IsSuccessful #
(# $
this$ ($
AmazonWebServiceResponse) A
responseB J
)J K
=>L N
response		 
.		 
HttpStatusCode		 
==		  "
HttpStatusCode		# 1
.		1 2
OK		2 4
;		4 5
public 

static 
bool 
IsDeleteSuccessful )
() *
this* .$
AmazonWebServiceResponse/ G
responseH P
)P Q
=>R T
response 
. 
HttpStatusCode 
==  "
HttpStatusCode# 1
.1 2
	NoContent2 ;
;; <
} ´
|C:\Users\jay.ahir\Desktop\OrchardCore-main\OrchardCore-main\src\OrchardCore\OrchardCore.FileStorage.AmazonS3\AwsDirectory.cs
	namespace 	
OrchardCore
 
. 
FileStorage !
.! "
AmazonS3" *
;* +
public 
class 
AwsDirectory 
: 
IFileStoreEntry +
{ 
private 
readonly 
string 
_path !
;! "
private 
readonly 
DateTime 
_lastModifiedUtc .
;. /
private		 
readonly		 
string		 
_name		 !
;		! "
private

 
readonly

 
string

 
_directoryPath

 *
;

* +
public 

AwsDirectory 
( 
string 
path #
,# $
DateTime% -
lastModifiedUtc. =
)= >
{ 
_path 
= 
path 
; 
_lastModifiedUtc 
= 
lastModifiedUtc *
;* +
_name 
= 
System 
. 
IO 
. 
Path 
. 
GetFileName *
(* +
path+ /
)/ 0
;0 1
_directoryPath 
= 
_path 
. 
Length %
>& '
_name( -
.- .
Length. 4
?5 6
_path7 <
[< =
..= ?
(? @
_path@ E
.E F
LengthF L
-M N
_nameO T
.T U
LengthU [
-\ ]
$num^ _
)_ `
]` a
:b c
Stringd j
.j k
Emptyk p
;p q
} 
public 

string 
Path 
=> 
_path 
;  
public 

string 
Name 
=> 
_name 
;  
public 

string 
DirectoryPath 
=>  "
_directoryPath# 1
;1 2
public 

long 
Length 
=> 
$num 
; 
public 

DateTime 
LastModifiedUtc #
=>$ &
_lastModifiedUtc' 7
;7 8
public 

bool 
IsDirectory 
=> 
true #
;# $
}  
wC:\Users\jay.ahir\Desktop\OrchardCore-main\OrchardCore-main\src\OrchardCore\OrchardCore.FileStorage.AmazonS3\AwsFile.cs
	namespace 	
OrchardCore
 
. 
FileStorage !
.! "
AmazonS3" *
;* +
public 
class 
AwsFile 
: 
IFileStoreEntry &
{ 
private 
readonly 
string 
_path !
;! "
private 
readonly 
string 
_name !
;! "
private		 
readonly		 
string		 
_directoryPath		 *
;		* +
private

 
readonly

 
long

 
?

 
_length

 "
;

" #
private 
readonly 
DateTimeOffset #
?# $
_lastModified% 2
;2 3
public 

AwsFile 
( 
string 
path 
, 
long  $
?$ %
length& ,
,, -
DateTimeOffset. <
?< =
lastModified> J
)J K
{ 
_path 
= 
path 
; 
_name 
= 
System 
. 
IO 
. 
Path 
. 
GetFileName *
(* +
_path+ 0
)0 1
;1 2
if 

( 
_name 
== 
_path 
) 
{ 	
_directoryPath 
= 
String #
.# $
Empty$ )
;) *
} 	
else 
{ 	
_directoryPath 
= 
_path "
[" #
..# %
(% &
_path& +
.+ ,
Length, 2
-3 4
_name5 :
.: ;
Length; A
-B C
$numD E
)E F
]F G
;G H
} 	
_length 
= 
length 
; 
_lastModified 
= 
lastModified $
;$ %
} 
public   

string   
Path   
=>   
_path   
;    
public"" 

string"" 
Name"" 
=>"" 
_name"" 
;""  
public$$ 

string$$ 
DirectoryPath$$ 
=>$$  "
_directoryPath$$# 1
;$$1 2
public&& 

long&& 
Length&& 
=>&& 
_length&& !
.&&! "
GetValueOrDefault&&" 3
(&&3 4
)&&4 5
;&&5 6
public(( 

DateTime(( 
LastModifiedUtc(( #
=>(($ &
_lastModified((' 4
.((4 5
GetValueOrDefault((5 F
(((F G
)((G H
.((H I
UtcDateTime((I T
;((T U
public** 

bool** 
IsDirectory** 
=>** 
false** $
;**$ %
}++ ﬂ¡
~C:\Users\jay.ahir\Desktop\OrchardCore-main\OrchardCore-main\src\OrchardCore\OrchardCore.FileStorage.AmazonS3\AwsFileStorage.cs
	namespace 	
OrchardCore
 
. 
FileStorage !
.! "
AmazonS3" *
;* +
public 
class 
AwsFileStore 
: 

IFileStore &
{ 
private 
readonly 
IClock 
_clock "
;" #
private 
readonly 
AwsStorageOptions &
_options' /
;/ 0
private 
readonly 
string 
_basePrefix '
;' (
private 
readonly 
	IAmazonS3 
_amazonS3Client .
;. /
public 

AwsFileStore 
( 
IClock 
clock $
,$ %
AwsStorageOptions& 7
options8 ?
,? @
	IAmazonS3A J
amazonS3ClientK Y
)Y Z
{ 
_clock 
= 
clock 
; 
_options 
= 
options 
; 
_amazonS3Client 
= 
amazonS3Client (
;( )
if   

(   
!   
IsNullOrEmpty   
(   
_options   #
.  # $
BasePath  $ ,
)  , -
)  - .
{!! 	
_basePrefix"" 
="" 
NormalizePrefix"" )
("") *
_options""* 2
.""2 3
BasePath""3 ;
)""; <
;""< =
}## 	
}$$ 
public&& 

async&& 
Task&& 
<&& 
IFileStoreEntry&& %
>&&% &
GetFileInfoAsync&&' 7
(&&7 8
string&&8 >
path&&? C
)&&C D
{'' 
try(( 
{)) 	
var** 
objectMetadata** 
=**  
await**! &
_amazonS3Client**' 6
.**6 7"
GetObjectMetadataAsync**7 M
(**M N
new**N Q$
GetObjectMetadataRequest**R j
{++ 

BucketName,, 
=,, 
_options,, %
.,,% &

BucketName,,& 0
,,,0 1
Key-- 
=-- 
this-- 
.-- 
Combine-- "
(--" #
_basePrefix--# .
,--. /
path--0 4
)--4 5
}.. 
).. 
;.. 
return00 
new00 
AwsFile00 
(00 
path00 #
,00# $
objectMetadata00% 3
.003 4
ContentLength004 A
,00A B
objectMetadata00C Q
.00Q R
LastModified00R ^
)00^ _
;00_ `
}11 	
catch33 
(33 
AmazonS3Exception33  
)33  !
{44 	
return55 
null55 
;55 
}66 	
}77 
public99 

async99 
Task99 
<99 
IFileStoreEntry99 %
>99% &!
GetDirectoryInfoAsync99' <
(99< =
string99= C
path99D H
)99H I
{:: 
if;; 

(;; 
IsNullOrEmpty;; 
(;; 
path;; 
);; 
);;  
{<< 	
return== 
new== 
AwsDirectory== #
(==# $
path==$ (
,==( )
_clock==* 0
.==0 1
UtcNow==1 7
)==7 8
;==8 9
}>> 	
var@@ 
awsDirectory@@ 
=@@ 
await@@  
_amazonS3Client@@! 0
.@@0 1
ListObjectsV2Async@@1 C
(@@C D
new@@D G 
ListObjectsV2Request@@H \
{AA 	

BucketNameBB 
=BB 
_optionsBB !
.BB! "

BucketNameBB" ,
,BB, -
PrefixCC 
=CC 
NormalizePrefixCC $
(CC$ %
thisCC% )
.CC) *
CombineCC* 1
(CC1 2
_basePrefixCC2 =
,CC= >
pathCC? C
)CCC D
)CCD E
,CCE F
MaxKeysDD 
=DD 
$numDD 
,DD 

FetchOwnerEE 
=EE 
falseEE 
}FF 	
)FF	 

;FF
 
returnHH 
awsDirectoryHH 
.HH 
	S3ObjectsHH %
.HH% &
AnyHH& )
(HH) *
)HH* +
?HH, -
newHH. 1
AwsDirectoryHH2 >
(HH> ?
pathHH? C
,HHC D
_clockHHE K
.HHK L
UtcNowHHL R
)HHR S
:HHT U
nullHHV Z
;HHZ [
}II 
publicKK 

asyncKK 
IAsyncEnumerableKK !
<KK! "
IFileStoreEntryKK" 1
>KK1 2$
GetDirectoryContentAsyncKK3 K
(KKK L
stringKKL R
pathKKS W
=KKX Y
nullKKZ ^
,KK^ _
boolLL !
includeSubDirectoriesLL "
=LL# $
falseLL% *
)LL* +
{MM 
varNN 
listObjectsResponseNN 
=NN  !
awaitNN" '
_amazonS3ClientNN( 7
.NN7 8
ListObjectsV2AsyncNN8 J
(NNJ K
newNNK N 
ListObjectsV2RequestNNO c
{OO 	

BucketNamePP 
=PP 
_optionsPP !
.PP! "

BucketNamePP" ,
,PP, -
	DelimiterQQ 
=QQ 
$strQQ 
,QQ 
PrefixRR 
=RR 
NormalizePrefixRR $
(RR$ %
thisRR% )
.RR) *
CombineRR* 1
(RR1 2
_basePrefixRR2 =
,RR= >
pathRR? C
)RRC D
)RRD E
,RRE F

FetchOwnerSS 
=SS 
falseSS 
,SS 
}TT 	
)TT	 

;TT
 
foreachVV 
(VV 
varVV 
fileVV 
inVV 
listObjectsResponseVV 0
.VV0 1
	S3ObjectsVV1 :
)VV: ;
{WW 	
varXX 
itemNameXX 
=XX 
PathXX 
.XX  
GetFileNameXX  +
(XX+ ,

WebUtilityXX, 6
.XX6 7
	UrlDecodeXX7 @
(XX@ A
fileXXA E
.XXE F
KeyXXF I
)XXI J
)XXJ K
;XXK L
ifZZ 
(ZZ !
includeSubDirectoriesZZ %
||ZZ& (
!ZZ) *
IsNullOrEmptyZZ* 7
(ZZ7 8
itemNameZZ8 @
)ZZ@ A
)ZZA B
{[[ 
if\\ 
(\\ 
IsNullOrEmpty\\ !
(\\! "
path\\" &
)\\& '
)\\' (
{]] 
path^^ 
=^^ 
$str^^ 
;^^ 
}__ 
var`` 
itemPath`` 
=`` 
this`` #
.``# $
Combine``$ +
(``+ ,
path``, 0
,``0 1
itemName``2 :
)``: ;
;``; <
yieldaa 
returnaa 
newaa  
AwsFileaa! (
(aa( )
itemPathaa) 1
,aa1 2
fileaa3 7
.aa7 8
Sizeaa8 <
,aa< =
fileaa> B
.aaB C
LastModifiedaaC O
)aaO P
;aaP Q
}bb 
}cc 	
foreachee 
(ee 
varee 
awsFolderPathee "
inee# %
listObjectsResponseee& 9
.ee9 :
CommonPrefixesee: H
)eeH I
{ff 	
vargg 

folderPathgg 
=gg 
awsFolderPathgg *
;gg* +
ifhh 
(hh 
!hh 
IsNullOrEmptyhh 
(hh 
_basePrefixhh *
)hh* +
)hh+ ,
{ii 

folderPathjj 
=jj 

folderPathjj '
.jj' (
	Substringjj( 1
(jj1 2
_basePrefixjj2 =
.jj= >
Lengthjj> D
-jjE F
$numjjG H
)jjH I
;jjI J
}kk 

folderPathmm 
=mm 

folderPathmm #
.mm# $
TrimEndmm$ +
(mm+ ,
$charmm, /
)mm/ 0
;mm0 1
yieldnn 
returnnn 
newnn 
AwsDirectorynn )
(nn) *

folderPathnn* 4
,nn4 5
_clocknn6 <
.nn< =
UtcNownn= C
)nnC D
;nnD E
}oo 	
}pp 
publicrr 

asyncrr 
Taskrr 
<rr 
boolrr 
>rr #
TryCreateDirectoryAsyncrr 3
(rr3 4
stringrr4 :
pathrr; ?
)rr? @
{ss 
trytt 
{uu 	
varvv 
responsevv 
=vv 
awaitvv  
_amazonS3Clientvv! 0
.vv0 1
PutObjectAsyncvv1 ?
(vv? @
newvv@ C
PutObjectRequestvvD T
{ww 

BucketNamexx 
=xx 
_optionsxx %
.xx% &

BucketNamexx& 0
,xx0 1
Keyyy 
=yy 
NormalizePrefixyy %
(yy% &
thisyy& *
.yy* +
Combineyy+ 2
(yy2 3
_basePrefixyy3 >
,yy> ?
pathyy@ D
)yyD E
)yyE F
}zz 
)zz 
;zz 
return|| 
response|| 
.|| 
IsSuccessful|| (
(||( )
)||) *
;||* +
}}} 	
catch~~ 
(~~ 
AmazonS3Exception~~  
)~~  !
{ 	
return
ÄÄ 
false
ÄÄ 
;
ÄÄ 
}
ÅÅ 	
}
ÇÇ 
public
ÑÑ 

async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
bool
ÑÑ 
>
ÑÑ  
TryDeleteFileAsync
ÑÑ .
(
ÑÑ. /
string
ÑÑ/ 5
path
ÑÑ6 :
)
ÑÑ: ;
{
ÖÖ 
try
ÜÜ 
{
áá 	
var
àà 
response
àà 
=
àà 
await
àà  
_amazonS3Client
àà! 0
.
àà0 1
DeleteObjectAsync
àà1 B
(
ààB C
new
ààC F!
DeleteObjectRequest
ààG Z
{
ââ 

BucketName
ää 
=
ää 
_options
ää %
.
ää% &

BucketName
ää& 0
,
ää0 1
Key
ãã 
=
ãã 
this
ãã 
.
ãã 
Combine
ãã "
(
ãã" #
_basePrefix
ãã# .
,
ãã. /
path
ãã0 4
)
ãã4 5
}
åå 
)
åå 
;
åå 
return
éé 
response
éé 
.
éé  
IsDeleteSuccessful
éé .
(
éé. /
)
éé/ 0
;
éé0 1
}
èè 	
catch
êê 
(
êê 
AmazonS3Exception
êê  
)
êê  !
{
ëë 	
return
íí 
false
íí 
;
íí 
}
ìì 	
}
îî 
public
ññ 

async
ññ 
Task
ññ 
<
ññ 
bool
ññ 
>
ññ %
TryDeleteDirectoryAsync
ññ 3
(
ññ3 4
string
ññ4 :
path
ññ; ?
)
ññ? @
{
óó 
if
òò 

(
òò  
IsNullOrWhiteSpace
òò 
(
òò 
path
òò #
)
òò# $
)
òò$ %
{
ôô 	
throw
öö 
new
öö  
FileStoreException
öö (
(
öö( )
$str
öö) H
)
ööH I
;
ööI J
}
õõ 	
var
ùù !
listObjectsResponse
ùù 
=
ùù  !
await
ùù" '
_amazonS3Client
ùù( 7
.
ùù7 8 
ListObjectsV2Async
ùù8 J
(
ùùJ K
new
ùùK N"
ListObjectsV2Request
ùùO c
{
ûû 	

BucketName
üü 
=
üü 
_options
üü !
.
üü! "

BucketName
üü" ,
,
üü, -
Prefix
†† 
=
†† 
NormalizePrefix
†† $
(
††$ %
this
††% )
.
††) *
Combine
††* 1
(
††1 2
_basePrefix
††2 =
,
††= >
path
††? C
)
††C D
)
††D E
}
°° 	
)
°°	 

;
°°
 
var
££ "
deleteObjectsRequest
££  
=
££! "
new
££# &"
DeleteObjectsRequest
££' ;
{
§§ 	

BucketName
•• 
=
•• 
_options
•• !
.
••! "

BucketName
••" ,
,
••, -
Objects
¶¶ 
=
¶¶ !
listObjectsResponse
¶¶ )
.
¶¶) *
	S3Objects
¶¶* 3
.
ßß 
Select
ßß 
(
ßß 
key
ßß 
=>
ßß 
new
ßß  #

KeyVersion
ßß$ .
{
ßß/ 0
Key
ßß1 4
=
ßß5 6
key
ßß7 :
.
ßß: ;
Key
ßß; >
}
ßß? @
)
ßß@ A
.
ßßA B
ToList
ßßB H
(
ßßH I
)
ßßI J
}
®® 	
;
®®	 

var
™™ 
response
™™ 
=
™™ 
await
™™ 
_amazonS3Client
™™ ,
.
™™, - 
DeleteObjectsAsync
™™- ?
(
™™? @"
deleteObjectsRequest
™™@ T
)
™™T U
;
™™U V
return
¨¨ 
response
¨¨ 
.
¨¨ 
IsSuccessful
¨¨ $
(
¨¨$ %
)
¨¨% &
;
¨¨& '
}
≠≠ 
public
ØØ 

async
ØØ 
Task
ØØ 
MoveFileAsync
ØØ #
(
ØØ# $
string
ØØ$ *
oldPath
ØØ+ 2
,
ØØ2 3
string
ØØ4 :
newPath
ØØ; B
)
ØØB C
{
∞∞ 
await
±± 
CopyFileAsync
±± 
(
±± 
oldPath
±± #
,
±±# $
newPath
±±% ,
)
±±, -
;
±±- .
await
≤≤  
TryDeleteFileAsync
≤≤  
(
≤≤  !
oldPath
≤≤! (
)
≤≤( )
;
≤≤) *
}
≥≥ 
public
µµ 

async
µµ 
Task
µµ 
CopyFileAsync
µµ #
(
µµ# $
string
µµ$ *
srcPath
µµ+ 2
,
µµ2 3
string
µµ4 :
dstPath
µµ; B
)
µµB C
{
∂∂ 
if
∑∑ 

(
∑∑ 
srcPath
∑∑ 
==
∑∑ 
dstPath
∑∑ 
)
∑∑ 
{
∏∏ 	
throw
ππ 
new
ππ 
ArgumentException
ππ '
(
ππ' (
$"
ππ( *
$str
ππ* 9
{
ππ9 :
nameof
ππ: @
(
ππ@ A
srcPath
ππA H
)
ππH I
}
ππI J
$str
ππJ O
{
ππO P
nameof
ππP V
(
ππV W
dstPath
ππW ^
)
ππ^ _
}
ππ_ `
$str
ππ` v
"
ππv w
)
ππw x
;
ππx y
}
∫∫ 	
try
ºº 
{
ΩΩ 	
await
ææ 
_amazonS3Client
ææ !
.
ææ! "$
GetObjectMetadataAsync
ææ" 8
(
ææ8 9
new
ææ9 <&
GetObjectMetadataRequest
ææ= U
{
øø 

BucketName
¿¿ 
=
¿¿ 
_options
¿¿ %
.
¿¿% &

BucketName
¿¿& 0
,
¿¿0 1
Key
¡¡ 
=
¡¡ 
this
¡¡ 
.
¡¡ 
Combine
¡¡ "
(
¡¡" #
_basePrefix
¡¡# .
,
¡¡. /
srcPath
¡¡0 7
)
¡¡7 8
}
¬¬ 
)
¬¬ 
;
¬¬ 
}
√√ 	
catch
ƒƒ 
(
ƒƒ 
AmazonS3Exception
ƒƒ  
)
ƒƒ  !
{
≈≈ 	
throw
∆∆ 
new
∆∆  
FileStoreException
∆∆ (
(
∆∆( )
$"
∆∆) +
$str
∆∆+ =
{
∆∆= >
srcPath
∆∆> E
}
∆∆E F
$str
∆∆F b
"
∆∆b c
)
∆∆c d
;
∆∆d e
}
«« 	
try
…… 
{
   	
var
ÀÀ 
listObjects
ÀÀ 
=
ÀÀ 
await
ÀÀ #
_amazonS3Client
ÀÀ$ 3
.
ÀÀ3 4 
ListObjectsV2Async
ÀÀ4 F
(
ÀÀF G
new
ÀÀG J"
ListObjectsV2Request
ÀÀK _
{
ÃÃ 

BucketName
ÕÕ 
=
ÕÕ 
_options
ÕÕ %
.
ÕÕ% &

BucketName
ÕÕ& 0
,
ÕÕ0 1
Prefix
ŒŒ 
=
ŒŒ 
this
ŒŒ 
.
ŒŒ 
Combine
ŒŒ %
(
ŒŒ% &
_basePrefix
ŒŒ& 1
,
ŒŒ1 2
dstPath
ŒŒ3 :
)
ŒŒ: ;
}
œœ 
)
œœ 
;
œœ 
if
—— 
(
—— 
listObjects
—— 
.
—— 
	S3Objects
—— %
.
——% &
Any
——& )
(
——) *
)
——* +
)
——+ ,
{
““ 
throw
”” 
new
””  
FileStoreException
”” ,
(
””, -
$"
””- /
$str
””/ A
{
””A B
srcPath
””B I
}
””I J
$str
””J {
{
””{ |
dstPath””| É
}””É Ñ
$str””Ñ Ü
"””Ü á
)””á à
;””à â
}
‘‘ 
var
÷÷  
copyObjectResponse
÷÷ "
=
÷÷# $
await
÷÷% *
_amazonS3Client
÷÷+ :
.
÷÷: ;
CopyObjectAsync
÷÷; J
(
÷÷J K
new
÷÷K N
CopyObjectRequest
÷÷O `
{
◊◊ 
SourceBucket
ÿÿ 
=
ÿÿ 
_options
ÿÿ '
.
ÿÿ' (

BucketName
ÿÿ( 2
,
ÿÿ2 3
	SourceKey
ŸŸ 
=
ŸŸ 
this
ŸŸ  
.
ŸŸ  !
Combine
ŸŸ! (
(
ŸŸ( )
_basePrefix
ŸŸ) 4
,
ŸŸ4 5
srcPath
ŸŸ6 =
)
ŸŸ= >
,
ŸŸ> ?
DestinationBucket
⁄⁄ !
=
⁄⁄" #
_options
⁄⁄$ ,
.
⁄⁄, -

BucketName
⁄⁄- 7
,
⁄⁄7 8
DestinationKey
€€ 
=
€€  
this
€€! %
.
€€% &
Combine
€€& -
(
€€- .
_basePrefix
€€. 9
,
€€9 :
dstPath
€€; B
)
€€B C
}
‹‹ 
)
‹‹ 
;
‹‹ 
if
ﬁﬁ 
(
ﬁﬁ 
!
ﬁﬁ  
copyObjectResponse
ﬁﬁ #
.
ﬁﬁ# $
IsSuccessful
ﬁﬁ$ 0
(
ﬁﬁ0 1
)
ﬁﬁ1 2
)
ﬁﬁ2 3
{
ﬂﬂ 
throw
‡‡ 
new
‡‡  
FileStoreException
‡‡ ,
(
‡‡, -
$"
‡‡- /
$str
‡‡/ I
{
‡‡I J
srcPath
‡‡J Q
}
‡‡Q R
$str
‡‡R S
"
‡‡S T
)
‡‡T U
;
‡‡U V
}
·· 
}
„„ 	
catch
‰‰ 
(
‰‰ 
AmazonS3Exception
‰‰  
)
‰‰  !
{
ÂÂ 	
throw
ÊÊ 
new
ÊÊ  
FileStoreException
ÊÊ (
(
ÊÊ( )
$"
ÊÊ) +
$str
ÊÊ+ E
{
ÊÊE F
srcPath
ÊÊF M
}
ÊÊM N
$str
ÊÊN O
"
ÊÊO P
)
ÊÊP Q
;
ÊÊQ R
}
ÁÁ 	
}
ËË 
public
ÍÍ 

Task
ÍÍ 
<
ÍÍ 
Stream
ÍÍ 
>
ÍÍ  
GetFileStreamAsync
ÍÍ *
(
ÍÍ* +
string
ÍÍ+ 1
path
ÍÍ2 6
)
ÍÍ6 7
{
ÎÎ 
try
ÏÏ 
{
ÌÌ 	
var
ÓÓ 
transferUtility
ÓÓ 
=
ÓÓ  !
new
ÓÓ" %
TransferUtility
ÓÓ& 5
(
ÓÓ5 6
_amazonS3Client
ÓÓ6 E
)
ÓÓE F
;
ÓÓF G
return
ÔÔ 
transferUtility
ÔÔ "
.
ÔÔ" #
OpenStreamAsync
ÔÔ# 2
(
ÔÔ2 3
_options
ÔÔ3 ;
.
ÔÔ; <

BucketName
ÔÔ< F
,
ÔÔF G
this
ÔÔH L
.
ÔÔL M
Combine
ÔÔM T
(
ÔÔT U
_basePrefix
ÔÔU `
,
ÔÔ` a
path
ÔÔb f
)
ÔÔf g
)
ÔÔg h
;
ÔÔh i
}
 	
catch
ÒÒ 
(
ÒÒ 
AmazonS3Exception
ÒÒ  
)
ÒÒ  !
{
ÚÚ 	
throw
ÛÛ 
new
ÛÛ  
FileStoreException
ÛÛ (
(
ÛÛ( )
$"
ÛÛ) +
$str
ÛÛ+ T
{
ÛÛT U
path
ÛÛU Y
}
ÛÛY Z
$str
ÛÛZ k
"
ÛÛk l
)
ÛÛl m
;
ÛÛm n
}
ÙÙ 	
}
ıı 
public
˜˜ 

Task
˜˜ 
<
˜˜ 
Stream
˜˜ 
>
˜˜  
GetFileStreamAsync
˜˜ *
(
˜˜* +
IFileStoreEntry
˜˜+ :
fileStoreEntry
˜˜; I
)
˜˜I J
{
¯¯ 
return
˘˘  
GetFileStreamAsync
˘˘ !
(
˘˘! "
fileStoreEntry
˘˘" 0
.
˘˘0 1
Path
˘˘1 5
)
˘˘5 6
;
˘˘6 7
}
˙˙ 
public
¸¸ 

async
¸¸ 
Task
¸¸ 
<
¸¸ 
string
¸¸ 
>
¸¸ '
CreateFileFromStreamAsync
¸¸ 7
(
¸¸7 8
string
¸¸8 >
path
¸¸? C
,
¸¸C D
Stream
¸¸E K
inputStream
¸¸L W
,
¸¸W X
bool
¸¸Y ]
	overwrite
¸¸^ g
=
¸¸h i
false
¸¸j o
)
¸¸o p
{
˝˝ 
try
˛˛ 
{
ˇˇ 	
if
ÄÄ 
(
ÄÄ 
!
ÄÄ 
	overwrite
ÄÄ 
)
ÄÄ 
{
ÅÅ 
var
ÇÇ 
listObjects
ÇÇ 
=
ÇÇ  !
await
ÇÇ" '
_amazonS3Client
ÇÇ( 7
.
ÇÇ7 8 
ListObjectsV2Async
ÇÇ8 J
(
ÇÇJ K
new
ÇÇK N"
ListObjectsV2Request
ÇÇO c
{
ÉÉ 

BucketName
ÑÑ 
=
ÑÑ  
_options
ÑÑ! )
.
ÑÑ) *

BucketName
ÑÑ* 4
,
ÑÑ4 5
Prefix
ÖÖ 
=
ÖÖ 
this
ÖÖ !
.
ÖÖ! "
Combine
ÖÖ" )
(
ÖÖ) *
_basePrefix
ÖÖ* 5
,
ÖÖ5 6
path
ÖÖ7 ;
)
ÖÖ; <
}
ÜÜ 
)
ÜÜ 
;
ÜÜ 
if
àà 
(
àà 
listObjects
àà 
.
àà  
	S3Objects
àà  )
.
àà) *
Any
àà* -
(
àà- .
)
àà. /
)
àà/ 0
{
ââ 
throw
ää 
new
ää  
FileStoreException
ää 0
(
ää0 1
$"
ää1 3
$str
ää3 G
{
ääG H
path
ääH L
}
ääL M
$str
ääM i
"
ääi j
)
ääj k
;
ääk l
}
ãã 
}
åå 
var
éé 
response
éé 
=
éé 
await
éé  
_amazonS3Client
éé! 0
.
éé0 1
PutObjectAsync
éé1 ?
(
éé? @
new
éé@ C
PutObjectRequest
ééD T
{
èè 

BucketName
êê 
=
êê 
_options
êê %
.
êê% &

BucketName
êê& 0
,
êê0 1
Key
ëë 
=
ëë 
this
ëë 
.
ëë 
Combine
ëë "
(
ëë" #
_basePrefix
ëë# .
,
ëë. /
path
ëë0 4
)
ëë4 5
,
ëë5 6
InputStream
íí 
=
íí 
inputStream
íí )
}
ìì 
)
ìì 
;
ìì 
if
ïï 
(
ïï 
!
ïï 
response
ïï 
.
ïï 
IsSuccessful
ïï &
(
ïï& '
)
ïï' (
)
ïï( )
{
ññ 
throw
óó 
new
óó  
FileStoreException
óó ,
(
óó, -
$"
óó- /
$str
óó/ C
{
óóC D
path
óóD H
}
óóH I
$str
óóI J
"
óóJ K
)
óóK L
;
óóL M
}
òò 
}
ôô 	
catch
öö 
(
öö 
AmazonS3Exception
öö  
ex
öö! #
)
öö# $
{
õõ 	
throw
úú 
new
úú  
FileStoreException
úú (
(
úú( )
$"
úú) +
$str
úú+ ?
{
úú? @
path
úú@ D
}
úúD E
$str
úúE g
{
úúg h
ex
úúh j
.
úúj k
Message
úúk r
}
úúr s
"
úús t
)
úút u
;
úúu v
}
ùù 	
return
üü 
path
üü 
;
üü 
}
†† 
private
¢¢ 
string
¢¢ 
NormalizePrefix
¢¢ "
(
¢¢" #
string
¢¢# )
prefix
¢¢* 0
)
¢¢0 1
{
££ 
prefix
§§ 
=
§§ 
prefix
§§ 
.
§§ 
Trim
§§ 
(
§§ 
$char
§§  
)
§§  !
+
§§" #
$char
§§$ '
;
§§' (
if
•• 

(
•• 
prefix
•• 
.
•• 
Length
•• 
==
•• 
$num
•• 
)
•• 
{
¶¶ 	
return
ßß 
Empty
ßß 
;
ßß 
}
®® 	
return
™™ 
prefix
™™ 
;
™™ 
}
´´ 
}¨¨ Ñ	
ÅC:\Users\jay.ahir\Desktop\OrchardCore-main\OrchardCore-main\src\OrchardCore\OrchardCore.FileStorage.AmazonS3\AwsStorageOptions.cs
	namespace 	
OrchardCore
 
. 
FileStorage !
.! "
AmazonS3" *
;* +
public 
class 
AwsStorageOptions 
{		 
public 

string 

BucketName 
{ 
get "
;" #
set$ '
;' (
}) *
public 

string 
BasePath 
{ 
get  
;  !
set" %
;% &
}' (
public 

bool 
CreateBucket 
{ 
get "
;" #
set$ '
;' (
}) *
public 


AWSOptions 

AwsOptions  
{! "
get# &
;& '
set( +
;+ ,
}- .
public!! 

bool!! 
RemoveBucket!! 
{!! 
get!! "
;!!" #
set!!$ '
;!!' (
}!!) *
}"" 